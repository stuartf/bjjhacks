<!-- This finds the current page so it can be highlighted. -->

{% for entry in site.data.navigation %}
  {% capture fullurl %}{{ site.baseurl }}{{ entry.url }}{% endcapture %}
  {% if fullurl == page.url %}
    {% assign current_page = fullurl %}
    {% break %}
  {% elsif page.url contains fullurl %}
    {% assign current_page = fullurl %}
    {% for subentry in entry.sublinks %}
      {% capture fullurl %}{{ site.baseurl }}{{ subentry.url }}{% endcapture %}
      {% if fullurl == page.url %}
        {% assign current_sub = fullurl %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

<!-- Then we build the nav bar. -->
<nav>
  <ul>
    {% for entry in site.data.navigation %}
      {% if entry.url == current_page %}
        {% assign current = ' class="current"' %}
      {% else %}
        {% assign current = null %}
      {% endif %}
      {% assign sublinks = entry.sublinks %}
      {% if sublinks %}
        <li{{ current }}>
          <a href="{{ site.baseurl }}{{ entry.url }}">{{ entry.title }}</a>
          <ul>
          {% for sublink in sublinks %}
            {% if sublink.url == current_sub %}
              {% assign currentsub = ' class="current"' %}
            {% else %}
              {% assign currentsub = null %}
            {% endif %}

            <li{{ currentsub }}><a href="{{ site.baseurl }}{{ sublink.url }}">{{ sublink.title }}</a></li>
          {% endfor %}
          </ul>
        </li>
      {% else %}
        <li{{ current }}><a href="{{ site.baseurl }}{{ entry.url }}">{{ entry.title }}</a></li>
      {% endif %}
    {% endfor %}
  </ul>
</nav>
